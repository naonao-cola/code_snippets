"""
é‚¢ä¸è¡Œâ„¢ï¸é€‰å¸æ¡†æ¶
Pythonæ•°å­—è´§å¸é‡åŒ–æŠ•èµ„è¯¾ç¨‹

ç‰ˆæƒæ‰€æœ‰ Â©ï¸ é‚¢ä¸è¡Œ
å¾®ä¿¡: xbx8662

æœªç»æˆæƒï¼Œä¸å¾—å¤åˆ¶ã€ä¿®æ”¹ã€æˆ–ä½¿ç”¨æœ¬ä»£ç çš„å…¨éƒ¨æˆ–éƒ¨åˆ†å†…å®¹ã€‚ä»…é™ä¸ªäººå­¦ä¹ ç”¨é€”ï¼Œç¦æ­¢å•†ä¸šç”¨é€”ã€‚

Author: é‚¢ä¸è¡Œ
"""
import warnings

import pandas as pd

# å¯¼å…¥å›æµ‹ç»“æœè·¯å¾„ã€é…ç½®æ¨¡å‹ã€æ—¥å¿—è®°å½•å™¨
from core.model.backtest_config import load_config
# å¯¼å…¥æ•°æ®å‡†å¤‡ã€å› å­è®¡ç®—ã€é€‰å¸æ¨¡å—ã€å›æµ‹æ¨¡å—çš„ä¸»è¦å‡½æ•°
from program.step1_prepare_data import prepare_data
from program.step2_calculate_factors import calc_factors
from program.step3_select_coins import select_coins, transfer_swap, aggregate_select_results
from program.step4_simulate_performance import simulate_performance

# ====================================================================================================
# ** è„šæœ¬è¿è¡Œå‰é…ç½® **
# è®¾å®šä¸€äº›é…ç½®ï¼Œå¹¶å¤„ç†åˆå§‹é—®é¢˜ï¼Œç¡®ä¿å›æµ‹ä¸»ç¨‹åºæ­£å¸¸è¿è¡Œ
# ====================================================================================================
warnings.filterwarnings('ignore')  # å¿½ç•¥ä¸å¿…è¦çš„è­¦å‘Šï¼Œä¿æŒè¾“å‡ºç•Œé¢ç®€æ´

# è®¾ç½® pandas çš„æ˜¾ç¤ºé€‰é¡¹ï¼Œä½¿è¾ƒå¤§æ•°æ®æ¡†åœ¨æ§åˆ¶å°ä¸­æ›´æ˜“é˜…è¯»
pd.set_option('expand_frame_repr', False)  # é¿å…åˆ—å¤ªå¤šæ—¶æ¢è¡Œ
pd.set_option('display.unicode.ambiguous_as_wide', True)  # æ”¹å–„å‘½ä»¤è¡Œè¾“å‡ºæ—¶çš„åˆ—å¯¹é½
pd.set_option('display.unicode.east_asian_width', True)

if __name__ == '__main__':
    """
    ** å›æµ‹ä¸»ç¨‹åº **
    è„šæœ¬ä¸»è¦æµç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
    0. åˆå§‹å‡†å¤‡
    1. å‡†å¤‡å›æµ‹æ‰€éœ€æ•°æ®ã€‚
    2. è®¡ç®—é€‰å¸å› å­ï¼ˆæŒ‡æ ‡ï¼‰ã€‚
    3. æ ¹æ®å› å­ç»“æœé€‰å¸ã€‚
    4. åŸºäºé€‰å¸ç»“æœæ¨¡æ‹ŸæŠ•èµ„ç»„åˆè¡¨ç°ã€‚
    """

    # ====================================================================================================
    # 0. åˆå§‹å‡†å¤‡
    # ====================================================================================================
    # å¦‚æœå›æµ‹ç»“æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºè¯¥ç›®å½•

    print('ğŸŒ€ å›æµ‹ç³»ç»Ÿå¯åŠ¨ä¸­ï¼Œç¨ç­‰...')

    # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–å¹¶åˆå§‹åŒ–å›æµ‹é…ç½®
    conf = load_config()

    # ====================================================================================================
    # 1. æ•°æ®å‡†å¤‡
    # ====================================================================================================
    # è°ƒç”¨æ•°æ®å‡†å¤‡å‡½æ•°ï¼ŒåŠ è½½å¹¶é¢„å¤„ç†å›æµ‹æ‰€éœ€çš„æ•°æ®ï¼Œå‡½æ•°ä½äº step1_prepare_data.py
    prepare_data(conf)

    # ====================================================================================================
    # 2. å› å­è®¡ç®—
    # ====================================================================================================
    # æ ¹æ®é…ç½®æ–‡ä»¶è®¡ç®—ç­–ç•¥å› å­å’Œè¿‡æ»¤å› å­ï¼Œå‡½æ•°ä½äº step2_calculate_factors.py
    calc_factors(conf)

    # ====================================================================================================
    # 3. é€‰å¸
    # ====================================================================================================
    # ä½¿ç”¨è®¡ç®—å¾—åˆ°çš„å› å­æ¥é€‰å¸ï¼Œå‡½æ•°ä½äº step3_select_coins.py
    select_coins(conf)  # é€‰å¸
    if is_short := conf.strategy_short is not None:
        select_coins(conf, is_short=True)  # é€‰å¸

    # èšåˆé€‰å¸ç»“æœ
    select_results = aggregate_select_results(conf)

    # ====================================================================================================
    # 4. åŸºäºé€‰å¸ç»“æœæ¨¡æ‹Ÿèµ„é‡‘æ›²çº¿
    # ====================================================================================================
    # æ ¹æ®é€‰å‡ºçš„å¸ç§æ¨¡æ‹ŸæŠ•èµ„ç»„åˆçš„è¡¨ç°ï¼Œè®¡ç®—èµ„é‡‘æ›²çº¿ï¼Œå³æŠ•èµ„ç»„åˆçš„æ”¶ç›Šå˜åŒ–æƒ…å†µï¼Œå‡½æ•°ä½äº step4_simulate_performance.py
    simulate_performance(conf, select_results)
